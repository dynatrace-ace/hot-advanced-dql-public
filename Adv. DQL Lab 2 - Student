{"version":"6","defaultTimeframe":{"from":"now()-7d","to":"now()"},"sections":[{"id":"8b25be63-5e67-4ad0-b785-8ce12ae03c6d","type":"markdown","markdown":"# Adv. DQL - Lab 2\n\n## DQL Repair Shop\n---"},{"id":"f137da53-92f8-47dd-b02a-9ce19bfa8040","type":"markdown","markdown":"### 2.1 Optimise \n\nYou've identified a colleage using a query that seems to be slow and scanning a lot of data. \n\n**Task:**\n- Reduce the scanned bytes of the query\n- Replace inefficient operations with efficient ones to improve execution time\n"},{"id":"70536a78-2fd9-4a90-8cb1-63161e693262","type":"dql","showTitle":false,"filterSegments":[],"drilldownPath":[],"height":67,"state":{"input":{"value":"fetch logs, scanLimitGBytes:-1\n| fieldsAdd parts = splitString(content, \" \")\n| fieldsAdd responseCode = parts[7]\n| sort responseCode desc\n| filter startsWith(dt.process.name,\"nginx hipstershop production\", caseSensitive:false)\n| filter startsWith(log.source, \"container output\", caseSensitive:false)\n| filter contains(responseCode,\"500\")\n| summarize failures = count()\n\n| append [fetch logs, scanLimitGBytes:-1\n| fieldsAdd parts = splitString(content, \" \")\n| fieldsAdd responseCode = parts[7]\n| sort responseCode desc\n| filter startsWith(dt.process.name,\"nginx hipstershop production\", caseSensitive:false)\n| filter startsWith(log.source, \"container output\", caseSensitive:false)\n| filter contains(responseCode,\"200\")\n| summarize success = count()]\n\n| summarize {sum(success), sum(failures)}","timeframe":{"from":"now()-7d","to":"now()"}},"visualization":"table","querySettings":{"maxResultRecords":1000,"defaultScanLimitGbytes":500,"maxResultMegaBytes":1,"defaultSamplingRatio":10,"enableSampling":false},"result":{"code":200,"value":{"records":[{"sum(success)":1826858,"sum(failures)":7585}],"metadata":{"grail":{"canonicalQuery":"fetch logs, scanLimitGBytes:-1\n| fieldsAdd parts = splitString(content, \" \")\n| fieldsAdd responseCode = parts[7]\n| sort responseCode desc\n| filter startsWith(dt.process.name, \"nginx hipstershop production\", caseSensitive:FALSE)\n| filter startsWith(log.source, \"container output\", caseSensitive:FALSE)\n| filter contains(responseCode, \"500\")\n| summarize failures = count()\n| append \n\t[\n\t\tfetch logs, scanLimitGBytes:-1\n\t\t| fieldsAdd parts = splitString(content, \" \")\n\t\t| fieldsAdd responseCode = parts[7]\n\t\t| sort responseCode desc\n\t\t| filter startsWith(dt.process.name, \"nginx hipstershop production\", caseSensitive:FALSE)\n\t\t| filter startsWith(log.source, \"container output\", caseSensitive:FALSE)\n\t\t| filter contains(responseCode, \"200\")\n\t\t| summarize success = count()\n\t]\n| summarize sum(success), sum(failures)","timezone":"Europe/London","query":"fetch logs, scanLimitGBytes:-1\n| fieldsAdd parts = splitString(content, \" \")\n| fieldsAdd responseCode = parts[7]\n| sort responseCode desc\n| filter startsWith(dt.process.name,\"nginx hipstershop production\", caseSensitive:false)\n| filter startsWith(log.source, \"container output\", caseSensitive:false)\n| filter contains(responseCode,\"500\")\n| summarize failures = count()\n\n| append [fetch logs, scanLimitGBytes:-1\n| fieldsAdd parts = splitString(content, \" \")\n| fieldsAdd responseCode = parts[7]\n| sort responseCode desc\n| filter startsWith(dt.process.name,\"nginx hipstershop production\", caseSensitive:false)\n| filter startsWith(log.source, \"container output\", caseSensitive:false)\n| filter contains(responseCode,\"200\")\n| summarize success = count()]\n\n| summarize {sum(success), sum(failures)}","scannedRecords":1067959604,"dqlVersion":"V1_0","scannedBytes":2226966294534,"scannedDataPoints":0,"analysisTimeframe":{"start":"2024-10-11T12:57:25.211Z","end":"2024-10-18T12:57:25.211Z"},"locale":"en-US","executionTimeMilliseconds":49898,"notifications":[],"queryId":"eec1ad05-53c5-4d4c-bdfc-4955df839e3f","sampled":false}},"types":[{"mappings":{"sum(success)":{"type":"double"},"sum(failures)":{"type":"double"}},"indexRange":[0,0]}]},"notifications":[],"querySettings":{"maxResultRecords":1000,"defaultScanLimitGbytes":500,"maxResultMegaBytes":1,"defaultSamplingRatio":10,"enableSampling":false},"dateTime":"2024-10-18T12:58:16.722Z","input":{"timeframe":{"from":"now()-7d","to":"now()"},"value":"fetch logs, scanLimitGBytes:-1\n| fieldsAdd parts = splitString(content, \" \")\n| fieldsAdd responseCode = parts[7]\n| sort responseCode desc\n| filter startsWith(dt.process.name,\"nginx hipstershop production\", caseSensitive:false)\n| filter startsWith(log.source, \"container output\", caseSensitive:false)\n| filter contains(responseCode,\"500\")\n| summarize failures = count()\n\n| append [fetch logs, scanLimitGBytes:-1\n| fieldsAdd parts = splitString(content, \" \")\n| fieldsAdd responseCode = parts[7]\n| sort responseCode desc\n| filter startsWith(dt.process.name,\"nginx hipstershop production\", caseSensitive:false)\n| filter startsWith(log.source, \"container output\", caseSensitive:false)\n| filter contains(responseCode,\"200\")\n| summarize success = count()]\n\n| summarize {sum(success), sum(failures)}"}},"visualizationSettings":{"thresholds":[],"chartSettings":{"gapPolicy":"gap","circleChartSettings":{"groupingThresholdType":"relative","groupingThresholdValue":0,"valueType":"relative"},"categoryOverrides":{},"curve":"linear","pointsDisplay":"auto","categoricalBarChartSettings":{"layout":"vertical","categoryAxisTickLayout":"horizontal","scale":"absolute","groupMode":"stacked","colorPaletteMode":"multi-color","categoryAxisLabel":"dt.kubernetes.cluster.name","valueAxisLabel":"","tooltipVariant":"single"},"colorPalette":"categorical","xAxisScaling":"analyzedTimeframe","truncationMode":"middle"},"singleValue":{"showLabel":true,"label":"","prefixIcon":"","recordField":"timestamp","autoscale":true,"alignment":"center","colorThresholdTarget":"value"},"table":{"rowDensity":"condensed","enableSparklines":false,"hiddenColumns":[],"linewrapEnabled":false,"lineWrapIds":[],"monospacedFontEnabled":false,"monospacedFontColumns":[],"firstVisibleRowIndex":0,"columnWidths":{"[\"content\"]":883.9479370117188,"[\"parts\"]":1341},"columnTypeOverrides":[{"fields":["content"],"id":1729253817950,"value":"log-content"}]},"honeycomb":{"shape":"hexagon","legend":{"hidden":false,"position":"auto"},"colorMode":"color-palette","colorPalette":"categorical","dataMappings":{},"displayedFields":[]},"histogram":{"legend":"auto","yAxis":{"label":"Frequency","scale":"linear"},"colorPalette":"categorical","dataMappings":[{"valueAxis":"sum(success)","rangeAxis":""},{"valueAxis":"sum(failures)","rangeAxis":""}]}},"state":"success"}},{"id":"cf9ad0d4-1c7b-46d9-8647-4d816e58ac25","type":"markdown","markdown":"#### Optimised query\n---"},{"id":"5a1834b1-2286-4292-b452-e1ad00d65caa","type":"dql","filterSegments":[],"drilldownPath":[],"previousFilterSegments":[],"state":{"input":{"value":"","timeframe":{"from":"now()-7d","to":"now()"}},"querySettings":{"maxResultRecords":1000,"defaultScanLimitGbytes":500,"maxResultMegaBytes":1,"defaultSamplingRatio":10,"enableSampling":false},"visualizationSettings":{"autoSelectVisualization":true},"state":"idle"}},{"id":"99805a21-778f-4dc9-90ba-a9c548cd66b7","type":"markdown","markdown":"### 2.2 Fix broken DQL\n\nAnother colleage has asked for help. They found some bits of DQL used by the colleagues but they can't get it to work.\n\n**Task:**\n- Reorder and fix issues in DQL\n"},{"id":"31e1a4ba-642a-4df5-999b-176724aef9c8","type":"dql","showTitle":false,"filterSegments":[],"drilldownPath":[],"state":{"input":{"value":"fetch dt.entity.process_group_instance\n| fields entity.name, dt.entity.host=runs_on[dt.entity.host],\n  dt.entity.process_group= instance_of[dt.entity.process_group],\n  dt.entity.process_group_instance = id\n\n| lookup sourceField:dt.entity.host, lookupField:dt.entity.host, [fetch bizevents\n  | filter event.type==\"carbon.measurement\"\n  | summarize sum = sum(carbon.emissions), by:{dt.entity.host}]\n| filter isNotNull(lookup.sum)\n\n| lookup [timeseries ts=avg(dt.process.cpu.usage), \n  by:{dt.entity.process_group_instance}\n  | fields cpu_sum= arraySum(ts), dt.entity.process_group_instance],sourceField:dt.entity.process_group_instance, \n  lookupField:id\n| fieldsAdd cpu_sum=lookup.cpu_sum\n\n| fieldsRename carbon_per_host=carbon.sum\n| fieldsRemove \"lookup*\"\n\n| lookup [timeseries ts=avg(dt.process.cpu.usage),  by:{dt.entity.process_group_instance}\n  | lookup [fetch dt.entity.process_group_instance], sourceField:dt.entity.process_group_instance, lookupField:id\n  | fields ts, dt.entity.process_group_instance, dt.entity.host = lookup.belongs_to[dt.entity.host]\n  | lookup [fetch dt.entity.process_group_instance], sourceField:dt.entity.process_group_instance, lookupField:id\n  | fieldsAdd cpusum = arraySum(ts)\n  | summarize cpuHostSum = toString(sum(cpusum)), by:{dt.entity.host}],\n  sourceField:dt.entity.host, lookupField:dt.entity.host\n\n  \n| fieldsAdd carbon_per_process = (if(isNull(cpu_sum),0,else:cpu_sum)/lookup.cpuHostSum) * carbon_per_host\n\n| fields dt.entity.host,dt.entity.process_group, dt.entity.process_group_instance, \n  dt.entity.process_group_instance.name = entity.name, carbon_per_process\n| sort carbon_per_process desc \n| limit 100","timeframe":{"from":"now()-7d","to":"now()"}},"visualization":"recordView","querySettings":{"maxResultRecords":1000,"defaultScanLimitGbytes":500,"maxResultMegaBytes":1,"defaultSamplingRatio":10,"enableSampling":false},"result":{"code":400,"error":"In the target, there is no field id.","notifications":[],"dateTime":"2024-10-22T11:33:20.941Z","input":{"timeframe":{"from":"now()-7d","to":"now()"},"value":"fetch dt.entity.process_group_instance\n| fields entity.name, dt.entity.host=runs_on[dt.entity.host],\n  dt.entity.process_group= instance_of[dt.entity.process_group],\n  dt.entity.process_group_instance = id\n\n| lookup sourceField:dt.entity.host, lookupField:dt.entity.host, [fetch bizevents\n  | filter event.type==\"carbon.measurement\"\n  | summarize sum = sum(carbon.emissions), by:{dt.entity.host}]\n| filter isNotNull(lookup.sum)\n\n| lookup [timeseries ts=avg(dt.process.cpu.usage), \n  by:{dt.entity.process_group_instance}\n  | fields cpu_sum= arraySum(ts), dt.entity.process_group_instance],sourceField:dt.entity.process_group_instance, \n  lookupField:id\n| fieldsAdd cpu_sum=lookup.cpu_sum\n\n| fieldsRename carbon_per_host=carbon.sum\n| fieldsRemove \"lookup*\"\n\n| lookup [timeseries ts=avg(dt.process.cpu.usage),  by:{dt.entity.process_group_instance}\n  | lookup [fetch dt.entity.process_group_instance], sourceField:dt.entity.process_group_instance, lookupField:id\n  | fields ts, dt.entity.process_group_instance, dt.entity.host = lookup.belongs_to[dt.entity.host]\n  | lookup [fetch dt.entity.process_group_instance], sourceField:dt.entity.process_group_instance, lookupField:id\n  | fieldsAdd cpusum = arraySum(ts)\n  | summarize cpuHostSum = toString(sum(cpusum)), by:{dt.entity.host}],\n  sourceField:dt.entity.host, lookupField:dt.entity.host\n\n  \n| fieldsAdd carbon_per_process = (if(isNull(cpu_sum),0,else:cpu_sum)/lookup.cpuHostSum) * carbon_per_host\n\n| fields dt.entity.host,dt.entity.process_group, dt.entity.process_group_instance, \n  dt.entity.process_group_instance.name = entity.name, carbon_per_process\n| sort carbon_per_process desc \n| limit 100"},"value":{"error":{"message":"JOIN_TARGET_FIELD_DOES_NOT_EXIST","details":{"exceptionType":"DQL-RESULT_TYPE","syntaxErrorPosition":{"start":{"column":15,"index":650,"line":14},"end":{"column":16,"index":651,"line":14}},"errorType":"JOIN_TARGET_FIELD_DOES_NOT_EXIST","errorMessage":"In the target, there is no field id.","arguments":["id"],"queryString":"fetch dt.entity.process_group_instance\n| fields entity.name, dt.entity.host=runs_on[dt.entity.host],\n  dt.entity.process_group= instance_of[dt.entity.process_group],\n  dt.entity.process_group_instance = id\n\n| lookup sourceField:dt.entity.host, lookupField:dt.entity.host, [fetch bizevents\n  | filter event.type==\"carbon.measurement\"\n  | summarize sum = sum(carbon.emissions), by:{dt.entity.host}]\n| filter isNotNull(lookup.sum)\n\n| lookup [timeseries ts=avg(dt.process.cpu.usage), \n  by:{dt.entity.process_group_instance}\n  | fields cpu_sum= arraySum(ts), dt.entity.process_group_instance],sourceField:dt.entity.process_group_instance, \n  lookupField:id\n| fieldsAdd cpu_sum=lookup.cpu_sum\n\n| fieldsRename carbon_per_host=carbon.sum\n| fieldsRemove \"lookup*\"\n\n| lookup [timeseries ts=avg(dt.process.cpu.usage),  by:{dt.entity.process_group_instance}\n  | lookup [fetch dt.entity.process_group_instance], sourceField:dt.entity.process_group_instance, lookupField:id\n  | fields ts, dt.entity.process_group_instance, dt.entity.host = lookup.belongs_to[dt.entity.host]\n  | lookup [fetch dt.entity.process_group_instance], sourceField:dt.entity.process_group_instance, lookupField:id\n  | fieldsAdd cpusum = arraySum(ts)\n  | summarize cpuHostSum = toString(sum(cpusum)), by:{dt.entity.host}],\n  sourceField:dt.entity.host, lookupField:dt.entity.host\n\n  \n| fieldsAdd carbon_per_process = (if(isNull(cpu_sum),0,else:cpu_sum)/lookup.cpuHostSum) * carbon_per_host\n\n| fields dt.entity.host,dt.entity.process_group, dt.entity.process_group_instance, \n  dt.entity.process_group_instance.name = entity.name, carbon_per_process\n| sort carbon_per_process desc \n| limit 100","errorMessageFormatSpecifierTypes":["FIELD_NAME"],"errorMessageFormat":"In the target, there is no field %1$s.","queryId":"41a8f0dd-ef8b-4192-862f-19565caaece4"},"code":400}},"querySettings":{"maxResultRecords":1000,"defaultScanLimitGbytes":500,"maxResultMegaBytes":1,"defaultSamplingRatio":10,"enableSampling":false}},"visualizationSettings":{"thresholds":[],"chartSettings":{"gapPolicy":"gap","circleChartSettings":{"groupingThresholdType":"relative","groupingThresholdValue":0,"valueType":"relative"},"categoryOverrides":{},"curve":"linear","pointsDisplay":"auto","categoricalBarChartSettings":{"layout":"vertical","categoryAxisTickLayout":"horizontal","scale":"absolute","groupMode":"stacked","colorPaletteMode":"multi-color","categoryAxisLabel":"dt.entity.process_group_instance.name","valueAxisLabel":"carbon_per_process","tooltipVariant":"single"},"colorPalette":"categorical","xAxisScaling":"analyzedTimeframe","truncationMode":"middle"},"singleValue":{"showLabel":true,"label":"","prefixIcon":"","recordField":"dt.entity.host","autoscale":true,"alignment":"center","colorThresholdTarget":"value"},"table":{"rowDensity":"condensed","enableSparklines":false,"hiddenColumns":[],"linewrapEnabled":false,"lineWrapIds":[],"monospacedFontEnabled":false,"monospacedFontColumns":[],"firstVisibleRowIndex":0,"columnWidths":{},"columnTypeOverrides":[]},"honeycomb":{"shape":"hexagon","legend":{"hidden":false,"position":"auto"},"colorMode":"color-palette","colorPalette":"blue","dataMappings":{},"displayedFields":[]},"histogram":{"legend":"auto","yAxis":{"label":"Frequency","scale":"linear"},"colorPalette":"categorical","dataMappings":[]}},"state":"error"}},{"id":"1a9eae1c-4aa7-496b-8116-f7aeeb4100b6","type":"markdown","markdown":"#### Fixed Query\n--- \n "},{"id":"eacf52bc-8692-4229-adf2-b4e730d3f7a2","type":"dql","showTitle":false,"filterSegments":[],"state":{"input":{"value":"","timeframe":{"from":"now()-7d","to":"now()"}},"querySettings":{"maxResultRecords":1000,"defaultScanLimitGbytes":500,"maxResultMegaBytes":1,"defaultSamplingRatio":10,"enableSampling":false},"state":"idle","visualizationSettings":{}}}],"defaultSegments":[]}